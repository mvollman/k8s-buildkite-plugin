apiVersion: v1
kind: Pod
metadata:
  annotations:
    cluster-autoscaler.kubernetes.io/safe-to-evict: "false"
    kubernetes.io/psp: eks.privileged
  labels:
    buildkite/plugin: 'k8s'
    build/branch: {{ branch }}
    build/pipeline: {{ pipeline }}
    app: beam-k8s-plugin
    build_number: {{ build_number }}
    src-job-id: {{ job_id }}
    pipeline_slug: {{ pipeline }}
  name: {{ pod_name }}
  namespace: {{ namespace }}
spec:
  containers:
  - args: {{ args }}
    command: {{ command }}
    env:
    {% for env in envs %}
    - {{ env }}
    {% endfor %}
    image: {{ image }}
    imagePullPolicy: IfNotPresent
    name: app
    resources:
      limits:
        cpu: {{ cpu_limits }}
        memory: {{ memory_limits }}
      requests:
        cpu: {{ cpu_requests }}
        memory: {{ memory_requests }}
    volumeMounts:
    - mountPath: /var/buildkite
      name: buildkite-agent-store
    - mountPath: /buildkite/builds
      name: buildkite-builds-store
    - mountPath: /var/run/docker.sock
      name: var-run-docker-sock
    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
      name: kube-api-access-6gg94
      readOnly: true
    - mountPath: /var/run/secrets/eks.amazonaws.com/serviceaccount
      name: aws-iam-token
      readOnly: true
  nodeName: {{ node_name }}
  securityContext:
    runAsGroup: {{ security_gid }}
    runAsNonRoot: true
    runAsUser: {{ security_uid }}
  serviceAccount: {{ service_account }}
  volumes:
  {% for volume in volumes %}
  - {{ volume }}
  {% endfor %}
