apiVersion: v1
kind: Pod
metadata:
  annotations:
    cluster-autoscaler.kubernetes.io/safe-to-evict: "false"
    kubernetes.io/psp: eks.privileged
  labels:
    buildkite/plugin: 'k8s'
    build/branch: {{ branch }}
    build/pipeline: {{ pipeline }}
    app: beam-k8s-plugin
    build_number: {{ build_number }}
    src-job-id: {{ job_id }}
    pipeline_slug: {{ pipeline }}
  name: {{ pod_name }}
  namespace: {{ namespace }}
spec:
  containers:
  - args: {{ args }}
    command: {{ command }}
    env:
    {% for env in envs %}
    - {{ env }}
    {% endfor %}
    image: {{ image }}
    imagePullPolicy: IfNotPresent
    name: app
    resources:
      limits:
        cpu: {{ cpu_limits }}
        memory: {{ memory_limits }}
      requests:
        cpu: {{ cpu_requests }}
        memory: {{ memory_requests }}
    volumeMounts: {{ volume_mounts }}
  nodeName: {{ node_name }}
  securityContext:
    runAsGroup: {{ security_gid }}
    runAsNonRoot: true
    runAsUser: {{ security_uid }}
  serviceAccount: {{ service_account }}
  volumes: {{ volumes }}
